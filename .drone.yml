name: drone-demo

kind: pipeline
type: docker
workspace:
  base: /go
  path: src/github.com/cqasen/drone-demo

steps:
  - name: build
    image: golang:alpine
    environment:
      GO111MODULE: on
      GOPROXY: https://mirrors.aliyun.com/goproxy/
    commands:
      - pwd
      - go env
      - go version

  - name: docker
    image: plugins/docker
    pull: true
    settings:
      repo: drone-demo
      auto_tag: true
      dockerfile: ./Dockerfile
      debug: true
      dry_run: true
    commands:
      - pwd
      - ls -al
      - docker -v
    when:
      event: [ push, tag ]
      branch: master

  - name: deploy
    image: appleboy/drone-ssh
    pull: true
    settings:
      host: example.me
      user: root
      script:
        - docker rmi -f drone-demo
        - echo "login docker"
        - echo "login success, pulling..."
        - docker pull drone-demo:latest
        - echo "image running"
        - docker run -p 8088:8088 -d drone-demo
        - echo "run success"
